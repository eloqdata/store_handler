# This is a prompt file for LLM to generate a purger for RocksDBCloud S3 files

## Background

* The RocksDB has the Manifest file as the entry point of each DB instance.
  - It contains the meta info of the DB files.
  - It also contains a set of SST files.

* The RocksDBCloud extends the RocksDB with the capability of store DB files in S3 storage.
  - It also supports forking a DB instance from an existing DB instance.
  - Each RocksDBCloud DB instance has a CLOUDMANIFEST file as the entry point of DB instance.
    - The CLOUDMANIFEST file contains a list of epoch postfixed Manifest file which appeared in its forking history. 
  - The DB forking process can be describe as steps (assuming the both DB instances are in same S3 object path, e.g. s3://bucket_name/object_path/)
    - Copy the CLOUDMANIFEST file from old CLOUDMANIFEST (e.g. CLOUDMANIFEST-0), by given a suffix to make distinguish between the two files, e.g. CLOUDMANIFEST-1.
    - Generate a new epoch (e.g. 582107b0a928437c) for an new RocksDB Mainfest file as postfix (e.g. Manifest-${epoch}).
    - Add the new Manifest file and the epoch into the CLOUDMANIFEST file as current epoch.
    - Then, an new DB instance can be start from the new CLOUDMANIFEST file.
    - All new SST file created by this new DB instance will be postfixed with the same epoch (e.g. 002434.sst-${epoch}).

## Problem

* Just like RocksDB, the SST files in RocksDBCloud can be deleted after compaction or the DB instance is removed.
* But, when the forking relation between RocksDBCloud DB instances are exists, we can not simplely delete those files, since they can be referenced by other DB instances.
* So, we have to prevent the ordinary SST file deletion happen in normal RocksDB, but introduce a purger program to perform the clean job.

## The Purger

* Existing algorithm already been implemented
  - List all SST files under the object_path.
  - List all CLOUDMANIFEST files under the object_path.
  - Load all current Manifest files.
  - Create a live file list by listing all live file number in each Manifest and find out 
    the correct epoch to form the complete SST file name (e.g. 002442.sst-582107b0a928437c).
  - Create a candidate obsolete file list by find out all SST files which are under the
    object_path but not in the live files list.
  - There can be some newly created SST file not in the Manifest file, so we only treat
    the candidate file older than the Manifest file as obsolete file.
  - Above algorithm are implemented in the single_object_path_purger.cc,
    please refer it for details.
    
* The problem of the current implemented purger
  - In RocksDB, the SST files are generated by memory table flush and SST compaction.
    * They are executed in parallel by a group of background threads, every one can update the Manifest file.
    * The Manifest file will be updated each time after a memory table flushed.
    * The Manifest file will be updated at the end of each compaction round, and several SST files can be generated during compaction.
  - So, the Manifest file can be updated before an new SST file were enlisted in the Manifest file, and the new SST file will be treated as obsolete.

## The improvement of the purger algorithm

* Base on the observation that all file numbers are monotone increased.
* We implement a rockdb::EventListener and subscribe the FlushBegin, CompactionBegin events
* When Flush and Compaction happens, we get the max file number from the db, and add to a time based slide window state
* At the end of the slide window, we find out the smaller file number in the state and update to a file in S3 object path.
  e.g. smallest_new_file_number-${epoch}
* If there are no flush or compaction happens during the time based slide window, the update smallest_new_file_number-${epoch} file with UINT64_MAX
* When purger check the candidate obsolete SST file, if its file number is small than the file number in smallest_new_file_number-${epoch}, then
  it can be treat as obsolete.


## Your tasks

* Implement the EventListener.
  - Reference the RocksDBEventLisener found in rocksdb_data_store_common.h
* Implement the time based slide window to update the smallest_new_file_number-${epoch} file.
* Implement a standalone purger program by referencing the single_object_path_purger.cc
